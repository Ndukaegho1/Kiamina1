version: "3.9"

services:
  mongo:
    image: mongo:7
    container_name: kiamina-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7-alpine
    container_name: kiamina-redis
    restart: unless-stopped
    ports:
      - "6379:6379"

  api-gateway:
    build:
      context: ./api-gateway
    container_name: kiamina-api-gateway
    environment:
      NODE_ENV: development
      PORT: 4100
      CORS_ORIGINS: http://localhost:5173
      AUTH_SERVICE_URL: http://auth-service:4101
      USERS_SERVICE_URL: http://users-service:4102
      DOCUMENTS_SERVICE_URL: http://documents-service:4103
      NOTIFICATIONS_SERVICE_URL: http://notifications-service:4104
    depends_on:
      - auth-service
      - users-service
      - documents-service
      - notifications-service
    ports:
      - "4100:4100"

  auth-service:
    build:
      context: ./services/auth-service
    container_name: kiamina-auth-service
    environment:
      NODE_ENV: development
      PORT: 4101
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DB_NAME: kiamina_auth
      OTP_HASH_SECRET: local-dev-secret
    depends_on:
      - mongo
    ports:
      - "4101:4101"

  users-service:
    build:
      context: ./services/users-service
    container_name: kiamina-users-service
    environment:
      NODE_ENV: development
      PORT: 4102
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DB_NAME: kiamina_users
    depends_on:
      - mongo
    ports:
      - "4102:4102"

  documents-service:
    build:
      context: ./services/documents-service
    container_name: kiamina-documents-service
    environment:
      NODE_ENV: development
      PORT: 4103
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DB_NAME: kiamina_documents
    depends_on:
      - mongo
    ports:
      - "4103:4103"

  notifications-service:
    build:
      context: ./services/notifications-service
    container_name: kiamina-notifications-service
    environment:
      NODE_ENV: development
      PORT: 4104
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DB_NAME: kiamina_notifications
    depends_on:
      - mongo
    ports:
      - "4104:4104"

volumes:
  mongo_data:
